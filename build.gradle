if (rootProject != project)
{
	def generator = { String alphabet, int n ->
		new Random().with {
			(1..n).collect { alphabet[ nextInt( alphabet.length() ) ] }.join()
		}
	}

	def rawJavaDir = "raw"
	def appendedGroup = rootProject.group != null && !rootProject.group.isEmpty() ? rootProject.group : generator( ('a'..'z').join(), 9 )
	def finalJavaDir = "gen"
	def srcDirPath = project.projectDir.getPath() + "/" + rawJavaDir
	def destDirPath = project.projectDir.getPath() + "/" + finalJavaDir

	task generateProjectSpecificPackage() << {
		def searchDir = file(srcDirPath)
		def srcTree = fileTree(dir: searchDir, include: '**/*.java')
		def filesToDelete = []
		def filesToAdd = []
		srcTree.each { file -> 
			def updatedContent = file.getText('UTF-8')
			updatedContent = updatedContent.replaceAll("package squeek.asmhelper", "package squeek.asmhelper." + appendedGroup)
			updatedContent = updatedContent.replaceAll("import squeek.asmhelper", "import squeek.asmhelper." + appendedGroup)
			def updatedFile = new File(destDirPath + "/squeek/asmhelper/" + rootProject.group + "/" + file.getName())
			filesToAdd += [ file: updatedFile, content: updatedContent ]
			logger.lifecycle("Processed " + file.getPath().replace(searchDir.getPath() + File.separator, "") + ", copying to " + updatedFile.getPath().replace(searchDir.getPath() + File.separator, ""))
		}
		filesToAdd.each { fileToAdd -> 
			if (!fileToAdd.file.getParentFile().exists())
				fileToAdd.file.getParentFile().mkdirs()
			fileToAdd.file.write(fileToAdd.content, 'UTF-8')
		}
	}

	rootProject.sourceSets.main.java.srcDirs += destDirPath
	rootProject.tasks.sourceMainJava.dependsOn(generateProjectSpecificPackage)
	rootProject.tasks.eclipse.dependsOn(generateProjectSpecificPackage)
	rootProject.tasks.idea.dependsOn(generateProjectSpecificPackage)
}